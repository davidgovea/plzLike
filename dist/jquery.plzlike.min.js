/*
  *  Please Like Us! - v0.0.1
  *  A jQuery plugin for Facebook like-gates, backed by Firebase or custom endpoint.
  *  https://github.com/davidgovea/plzlike
  *
  *  Made by David Govea
  *  MIT License
*/(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};!function(b,c){var d,e,f;return f="plzLike",e={appId:"",page:"",fbScope:"user_likes,email",width:null,height:null,firebaseUrl:"",firebaseNs:"plzlike-entrants",webhookUrl:"",method:"POST"},d=function(){function d(c,d){this.element=c,this.changeView=a(this.changeView,this),this._submitPost=a(this._submitPost,this),this._submitFirebase=a(this._submitFirebase,this),this.settings=b.extend({},e,d),this._defaults=e,this._name=f,this.init()}return d.prototype.init=function(){var a=this;return b(this.element).addClass("plzlike-container"),this.changeView("loading"),this.loadFB(function(){return a.fetchPageId(function(){return a.changeView("begin")}),a.fbAuthSubscribe(),a.initClickHandlers()}),this.settings.firebaseUrl?this.firebase=new Firebase(this.settings.firebaseUrl):void 0},d.prototype.loadFB=function(a){var d=this;return null!=c.FB?setTimeout(a,0):b.getScript("//connect.facebook.net/en_UK/all.js",function(){return FB.init({appId:d.settings.appId,status:!1,xfbml:!1}),a()})},d.prototype.fetchPageId=function(a){var b=this;return FB.api("/"+this.settings.page,function(c){return b.settings.pageId=c.id,a()})},d.prototype.fbAuthSubscribe=function(){var a=this;return FB.Event.subscribe("auth.authResponseChange",function(b){var c;return"connected"===b.status?(a.userId=null!=(c=b.authResponse)?c.userID:void 0,FB.api("/me/likes/"+a.settings.pageId,function(b){var c;return(null!=(c=b.data)?c.length:void 0)?a.changeView("liked"):(a.changeView("like"),FB.Event.subscribe("edge.create",function(b){return b.match(new RegExp(a.settings.page,"i"))?a.changeView("liked"):void 0}))})):alert("You must connect with our app to enter")})},d.prototype.initClickHandlers=function(){var a,c=this;return a=b(this.element),a.on("click",".plzlike-begin button",function(a){return a.preventDefault(),a.stopPropagation(),FB.login(function(){},{scope:c.settings.fbScope})}),a.on("click",".plzlike-liked button",function(a){return a.preventDefault(),a.stopPropagation(),c.submit()})},d.prototype.submit=function(){var a,b=this;return a=function(){return b.changeView("done")},FB.api("/me",function(c){var d;if(b.firebase)d=b._submitFirebase;else{if(!b.settings.webhookUrl)throw new Error("No data store configured");d=b._submitPost}return d(c,a)})},d.prototype._submitFirebase=function(a,b){var c,d=this;return c=this.firebase.child(""+this.settings.firebaseNs+"/"+this.userId),c.on("value",function(e){return c.off("value"),null!=(null!=e?e.val():void 0)?d.changeView("dupe"):c.set(a,b)})},d.prototype._submitPost=function(a,c){var d=this;return b.ajax({url:this.settings.webhookUrl,method:this.settings.method,data:a,success:function(a){var b;return 409===(b=a.code)||420===b||429===b?d.changeView("dupe"):c()},error:function(a,b,d){return c(new Error(d))}})},d.prototype.changeView=function(a){var c,d,e;return c=b(this.element),e=c.find(".plzlike-"+a),e.length?d=e:(d=b("<div class='plzlike-"+a+"'>"+this.templates[a].call(this)+"</div>"),c.append(d)),c.find(".plzlike-active").removeClass("plzlike-active"),"undefined"!=typeof FB&&null!==FB&&FB.XFBML.parse(d.get(0)),setTimeout(function(){return d.addClass("plzlike-active")},0)},d.prototype.templates={loading:function(){return"LOADING..."},begin:function(){return"<button>Get started</button>"},like:function(){var a,c;return'<div class="fb-like-box"\n	data-href="http://www.facebook.com/'+this.settings.pageId+'"\n	data-width="'+(null!=(a=this.settings.width)?a:b(this.element).width())+'"\n	data-height="'+((null!=(c=this.settings.height)?c:b(this.element).height())||"")+'"\n	data-colorscheme="light"\n	data-show-faces="true"\n	data-header="false"\n	data-stream="false"\n	data-show-border="false">\n</div>'},liked:function(){return'<button>Submit entry</button>\n<div class="disclaimer">\n	<small>This promotion is in no way sponsored, endorsed, administered by, or associated with Facebook.</small>\n</div>'},done:function(){return'Thanks for entering! Why not share?\n<div class="fb-send"\n	data-href="'+c.location.href+"\"\n	data-colorscheme='light'>\n</div>"},dupe:function(){return"Already entered"}},d}.call(this),b.fn[f]=function(a){return this.each(function(){return b.data(this,"plugin_"+f)?void 0:b.data(this,"plugin_"+f,new d(this,a))})}}(jQuery,window,document)}).call(this);